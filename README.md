# JPA Practice
Don't need to set up SpringBoot. \
Understand the way of JPA how to operate.

## Hibernate configuration
Hibernate is implementation of JPA interface. 

You need to set up before entering project.

#### src/main/resources/META-INF/persistence.xml
```xml
<property name="hibernate.hbm2ddl.auto" value="validate" />
```

### hbm2dll.value option

| Value       | Description                                                  | When to use                                                |
|-------------|--------------------------------------------------------------|------------------------------------------------------------|
| create      | ì‹œì‘ì‹œ ìŠ¤í‚¤ë§ˆë¥¼ ì¬ìƒì„±                                                 | ê°œë°œ ì´ˆê¸°ë‹¨ê³„                                                    |
| create-drop | ì–´í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ ì‹œì ì— ìƒì„±í–ˆë˜ ìŠ¤í‚¤ë§ˆ ì‚­ì œ                                    | í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì‹¤í–‰í•˜ê³  ê¹”ë”í•˜ê²Œ ëª¨ë‘ ì‚­ì œí•˜ê³  ì‹¶ì„ ë•Œ                            |
| update      | ì‹œì‘ì‹œ Entity class êµ¬ì„±ê³¼ ìŠ¤í‚¤ë§ˆë¥¼ ë¹„êµí•˜ì—¬ ì»¬ëŸ¼ ì¶”ê°€/ì‚­ì œ , ê¸°ì¡´ ìŠ¤í‚¤ë§ˆë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³  ìœ ì§€ | ê°œë°œ ì´ˆê¸°ë‹¨ê³„ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ì„œë²„ì—ì„œ ë³€ê²½ëœ ìŠ¤í‚¤ë§ˆë§Œ ALTER ë¡œ ë°˜ì˜í•˜ê³  ì‹¶ì„ ë•Œ (ìš´ì˜ì—ëŠ” ì‚¬ìš© X) |
| validate    | ì‹œì‘ì‹œ Entity class êµ¬ì„±ê³¼ ìŠ¤í‚¤ë§ˆê°€ ë‹¤ë¥´ë‹¤ë©´ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚´.                     | Entity class ì •ì˜ì™€ í…Œì´ë¸”ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ë§Œ ë¯¸ë¦¬ í™•ì¸ í•  ë•Œ                 |
| none        | ì‚¬ìš©í•˜ì§€ ì•ŠìŒ                                                      | ê´€ë¡€ìƒ ìœ„ ì˜µì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šì„ ë•Œ ëª…ì‹œ                                     |  

> ğŸ“ staging ë° production ì—ëŠ” `validate`, `none` ì„ ì œì™¸í•˜ê³  ì ˆëŒ€ ì“°ì§€ ë§ˆë¼.
> ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
> **ê·¸ëƒ¥ ëª¨ë¥´ê² ìœ¼ë©´ ì•ˆì „í•˜ê²Œ `validate`, `none` ì„ ì¨ë¼.**

### DB DDL Tip 
- DDL ì€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§ì ‘ ì‘ì„±í•´ì„œ í…ŒìŠ¤íŠ¸ DB ì— ë¨¼ì € í…ŒìŠ¤íŠ¸ í•œ í›„ ë°˜ì˜í•˜ë¼. \
ìë™ìœ¼ë¡œ íˆ´ì´ ìƒì„±í•´ì£¼ëŠ” DDL ì—ëŠ” ìœ„í—˜ì´ ì¡´ì¬í•œë‹¤.
- ALTER, DROP ê°™ì€ DDL ì€ ì• ì´ˆì— ê°œë°œìê°€ ì“°ì§€ ëª»í•˜ê²Œ ê³„ì • ë‹¨ìœ„ë¡œ ì ê¶ˆë†“ëŠ”ë‹¤.
- ìµœëŒ€í•œ ë§ì€ ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ì—¬ Entity class ë‚´ì—ì„œ ì»¬ëŸ¼ ì •ë³´ë¥¼ ì •í™•íˆ ê°œë°œìê°€ ì•Œì•„ë³¼ ìˆ˜ ìˆê²Œ ëª…ì‹œí•˜ë¼. \
ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì§ì ‘ DB DDL ì„ í™•ì¸í•´ì•¼í•´ì„œ ë²ˆê±°ë¡­ë‹¤.

## Entity - Table mapping guide

### Mapping annotations
| Index       | Description                                         |
|-------------|-----------------------------------------------------|
| @Column     | Column                                              |
| @Comment    | Comments on table, column ..                        |
| @Temporal   | Date/Time/Timestamp                                 |
| @Enumerated | enum type                                           |
| @Lob        | BLOB, CLOB                                          |
| Transient   | Not mapping to DB, just use in application instance |

> âœ’ï¸ From java 8, Use `LocalDateTime` instead of `@Temporal` \
Is there any timezone issue?

### Column annotations
| Index            | Description                          |
|------------------|--------------------------------------|
| name             | column name                          |
| nullable         | NULL constraint                      |
| unique           | Unique constraint                    |
| columnDefinition | Input column info using sql syntax   |
| length           | Length of varchar, varchar2, etc..   |
| precision scale  | Use in BigDecimal or BigInteger type |

### Primary Key Mapping
Use `@GeneratedValue`

| Generation Strategy | Description                                             |
|---------------------|---------------------------------------------------------|
| Auto                | Chosen automatically according to DBMS                  |
| IDENTITY            | Generated by default as IDENTITY                        |
| SEQUENCE            | Create and use database sequence object and allocate it |
| TABLE               | Use key generator table (Not recommended)               |

### Tips on Primary Key
You need set the PK meets conditions as shown below.
> 1. Use Long type
> 2. Use Candidate key
> 3. Use Key generation 

### Compare IDENTITY vs SEQUENCE strategy
You can choice **SEQUENCE** when you need JDBC batch insert query \
IDENTITY strategy doesn't support batch optimization since it's required insert query executed to DB for getting generated key.

Refer to [this docs](https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators)

---

# Relationship

![img.png](./src/main/resources/assets/entity_diagram.png)

#### Member.java
```java
@Table(name = "member")
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Getter
public class Member {
    // ..
    @ManyToOne
    @JoinColumn(name = "team_id")
    private Team team;
    // ..
}
```

#### Team.java
```java
@Entity
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
public class Team {
    // ..
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name = "team_id")
    private Long id;
    // ..
}
```

### Entity class
íšŒì› -> íŒ€ ì—°ê´€ê´€ê³„ 1ê°œ \
íŒ€ -> íšŒì› ì—°ê´€ê´€ê³„ 1ê°œ \
ê·¸ë˜ì„œ ì–‘ë°©í–¥ìœ¼ë¡œ ë³´ì´ì§€ë§Œ ì‚¬ì‹¤ìƒ ë‹¨ë°©í–¥ì´ 2ê°œ \
ê°ì²´ë¥¼ ì–‘ë°©í–¥ìœ¼ë¡œ ì°¸ì¡°í•˜ë ¤ë©´ ë‹¨ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ 2ê°œ ë§Œë“¤ì–´ì•¼í•œë‹¤.

### Dilemma
> ë‘˜ ì¤‘ ì–´ëŠ ê°ì²´ì—ì„œ ì™¸ë˜í‚¤ë¥¼ ê´€ë¦¬í• ì§€ **í•˜ë‚˜ë¥¼ ê²°ì •**í•´ì•¼í•¨. \
> ì´ë•Œ ì„ íƒëœ ì—”í‹°í‹° ê°ì²´ë¥¼ **ì—°ê´€ê´€ê³„ ì£¼ì¸**ì´ë¼ í•¨. \
> **ì—°ê´€ê´€ê³„ ì£¼ì¸ë§Œì´ ì™¸ë˜ í‚¤ë¥¼ ê´€ë¦¬ (ë“±ë¡ & ìˆ˜ì •)** \
> **ì£¼ì¸ì´ ì•„ë‹Œ ìª½ì€ ì˜¤ë¡œì§€ ì¡°íšŒë§Œ ê°€ëŠ¥.** \
> `@JoinColumn` annotation ì„ ê°€ì§„ ìª½ì´ ì—°ê´€ê´€ê³„ ì£¼ì¸ 

```java
team
    .getMembers()[0]
    .setTeam("~~")
```
**ìˆ˜ì • ì‹œë„ëŠ” Team ì—ì„œ í–ˆì§€ë§Œ , Member ì— ì˜í–¥ì„ ë¯¸ì¹œë‹¤.**

### Table relation
í…Œì´ë¸” ê´€ì ìœ¼ë¡œ ì—°ê´€ê´€ê³„ë¥¼ ë³´ë©´ ê´€ê³„ë¥¼ ê²°ì •í•˜ëŠ” ê²ƒì€ ì™¸ë˜í‚¤ ë‹¨ í•˜ë‚˜ë‹¤. \
team_id ë¥¼ ê°€ì§„ FK ìˆëŠ”ê±° í•˜ë‚˜ë¡œ í…Œì´ë¸” ìƒì—ì„œëŠ” ëª¨ë“  ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

## ğŸ“ Entity class ì„¤ê³„ íŒ
### 1.  ë‹¨ë°©í–¥ ì—°ê´€ê´€ê³„ë¡œ ì—”í‹°í‹° í´ë˜ìŠ¤ ì„¤ê³„ë¥¼ ëë‚´ë¼.
ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ëŠ” ê¼­ í•„ìš”í•  ë•Œë§Œ ì‚¬ìš©í•´ì•¼í•œë‹¤.

### 2. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ì•„ë‹Œ ì™¸ë˜í‚¤ ìœ„ì¹˜ë¡œ ì—°ê´€ê´€ê³„ ì£¼ì¸ ê²°ì •

#### _ì™¸ë˜í‚¤ë¥¼ ê°€ì§„ ì—”í‹°í‹°ë¥¼ ì—°ê´€ê´€ê³„ ì£¼ì¸ìœ¼ë¡œ ì •í•´ì•¼í•œë‹¤._
1:N ì¼ ë•Œ \
ë¶€ëª¨ 1ì„ `mappedBy` ë¥¼ í†µí•´ ìì‹ì„ ë§µí•‘í•˜ê³  `OneToMany`ìœ¼ë¡œ ì§€ì •í•œë‹¤.\
ìì‹ Nì„ ì—°ê´€ê´€ê³„ ì£¼ì¸ìœ¼ë¡œ ë‘ì–´ `ManyToOne` ìœ¼ë¡œ ì§€ì •í•œë‹¤. \
mappedBy ì— ì˜í•´ ì°¸ì¡°ë˜ëŠ” ë³€ìˆ˜ê°€ Foreign key ë‹¤.


#### _ì™œ ìì‹ì„ ì—°ê´€ê´€ê³„ ì£¼ì¸ìœ¼ë¡œ ë‘ëŠ”ê°€?_
ë¶€ëª¨ì¸ íŒ€ì˜ `members` ë¥¼ ìˆ˜ì •í•˜ì—¬ í…Œì´ë¸” ì—…ë°ì´íŠ¸ë¥¼ í•œë‹¤ê³  ê°€ì •í•˜ë©´ \
ê°ì²´ ìƒì—ì„œ ë³€í™”ë¥¼ ê°€í•œ ìª½ì€ ë¶€ëª¨ ê°ì²´ì¸ë° \
ìì‹ ê°ì²´ì™€ í…Œì´ë¸”ì— Update query ê°€ ì‹¤í–‰ëœë‹¤.

### 3. ê°ì²´ ìƒì—ë„ ëª¨ë‘ ì—°ê´€ê´€ê³„ ë¡œì§ì„ ì ìš©í•œ ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ ì‚¬ìš©
ê°ì²´ìƒì—ì„œë„ ì„œë¡œ ê´€ê³„ë¥¼ ë§ºì–´ì¤˜ì•¼ ì´ìŠˆê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤.
```java
/**
 * ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ
 * @param team
 */
public void changeMemberTeam(Team team) {
    this.team = team;
    team.getMembers().add(this);
}
```

### 4. Lombok ì˜ toString() ì´ë‚˜ JSON ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì‹œ ë¬´í•œë£¨í”„ì— ë¹ ì§€ì§€ ì•Šë„ë¡ ìœ ì˜
í•´ë‹¹ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œì§ì„ ë³´ë©´ member -> team -> members -> team -> members ... ë“± ê³„ì† íƒ€ê³  ë“¤ì–´ê°ˆ ìœ„í—˜ì´ ìˆìŒ.

### 5. Controller ì—ì„œ Entity ë¥¼ ê·¸ëŒ€ë¡œ return í•˜ì§€ ì•Šê³  DTO ë¥¼ ì‚¬ìš©í•˜ê¸¸ ê¶Œì¥.
Entity ë¥¼ ê·¸ëŒ€ë¡œ ë¦¬í„´í•œë‹¤ëŠ” ê²ƒì€ Entity ì»¬ëŸ¼ ë³€ê²½ì‹œ API spec ì´ ê°™ì´ ë³€í•  ìˆ˜ ìˆë‹¤.

### 6. @ManyToMany ëŒ€ì‹  ë§µí•‘ í…Œì´ë¸”ì„ ì‚¬ìš©í•˜ê³  PKëŠ” ê³ ìœ ì˜ ê°’ìœ¼ë¡œë§Œ ì§€ì •.
item_id ì™€ order_id ë“±ì„ í•©ì³ ë³µí•©í‚¤ë¥¼ ê¸°ë³¸í‚¤ë¡œ ì§€ì •í•  ìˆ˜ë„ ìˆìœ¼ë‚˜ \
ì •í•©ì„±ì—ë§Œ ì¢‹ì„ ë¿ ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ ìš´ì˜ë©´ì—ì„œëŠ” ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ì¢…ì†ì„±ìœ¼ë¡œ ì¸í•´ ë§¤ìš° ì–´ë ¤ì›Œì§€ê¸° ë•Œë¬¸ì— \
ë¹„ì¦ˆë‹ˆìŠ¤ìƒ ì˜ë¯¸ ì—†ë”ë¼ë„ ë³„ë„ì˜ order_item_id ë¥¼ `auto_increment` ë¡œ ê±¸ê¸¸ ì¶”ì²œí•œë‹¤.

![order_item.png](src/main/resources/assets/mapping_table_erd.png)


